<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ü–∞–ø–∞ –¢—Ä—É–±–æ–∫ ‚Äî –ú–æ—è –∏–≥—Ä–∞</title>
    <link rel="stylesheet" href="main.css">
    <link rel="stylesheet" href="styles.css">
    
    <!-- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body>
    <div class="container">
        <div class="papyrus">
            <div class="hieroglyph-border"></div>
            <div class="torn-edge top-edge"></div>
            <div class="torn-edge right-edge"></div>
            <div class="torn-edge bottom-edge"></div>
            <div class="torn-edge left-edge"></div>
            <div class="worn-spot spot1"></div>
            <div class="worn-spot spot2"></div>
            <div class="worn-spot spot3"></div>
            <div class="scarab top-left">ìÜ£</div>
            <div class="scarab top-right">ìÜ£</div>
            <div class="scarab bottom-left">ìÜ£</div>
            <div class="scarab bottom-right">ìÜ£</div>

            <div id="gameMain" style="display: block;">
                <div class="title">
                    <h1>–í–∞—à–∞ –∫–æ–º–Ω–∞—Ç–∞</h1>
                </div>
                <div class="game-room" id="gameRoom">
                    <div class="game-room-header">
                        <h2 class="game-room-title" id="gameRoomTitle">–ö–æ–º–Ω–∞—Ç–∞</h2>
                        <span class="game-room-status" id="gameRoomStatus">–û–∂–∏–¥–∞–Ω–∏–µ</span>
                    </div>
                    <div class="question-box">
                        <h3>–í–æ–ø—Ä–æ—Å:</h3>
                        <p class="question-text" id="gameQuestionText">‚Äî</p>
                    </div>
                    <div class="game-room-info">
                        <div class="game-room-players">
                            <span class="game-room-player" id="gameRoomPlayers">–ò–≥—Ä–æ–∫–æ–≤: 0/10</span>
                            <span class="game-room-player" id="gameRoomAnswers">–û—Ç–≤–µ—Ç–æ–≤: 0</span>
                        </div>
                    </div>
                    <div id="gameActions"></div>
                </div>
                <div id="userAnswerDisplay" style="display: none;"></div>
            </div>
        </div>
    </div>
    <script src="indexedDB.js"></script>
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –≤—ã—Ö–æ–¥–∞
        window.preventUnload = true;
        window.navigationHistory = [];

        // –§—É–Ω–∫—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞
        function safePageTransition(url, options = {}) {
            const {
                saveHistory = true,
                clearPreviousState = false,
                additionalData = null
            } = options;

            console.log(`–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥: ${url}`);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
            if (window.currentGame && window.currentGame.id) {
                saveGameStateToIndexedDB(window.currentGame.id, window.currentGame);
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
            if (window.currentUser && window.currentUser.id) {
                saveUserToIndexedDB(window.currentUser);
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            if (additionalData) {
                saveAppStateToIndexedDB('transitionData', additionalData);
            }

            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è
            if (clearPreviousState) {
                localStorage.clear();
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞—Ä—à—Ä—É—Ç
            if (saveHistory) {
                window.navigationHistory.push(url);
                saveLastRoute(url);
            }

            // –†–∞–∑—Ä–µ—à–∞–µ–º –≤—ã—Ö–æ–¥
            window.preventUnload = false;

            // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –Ω–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            window.location.href = url;
        }

        // –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–∞–∑–∞–¥
        function goBack() {
            if (window.navigationHistory.length > 1) {
                window.navigationHistory.pop();
                const previousPage = window.navigationHistory[window.navigationHistory.length - 1];
                safePageTransition(previousPage, { saveHistory: false });
            } else {
                safePageTransition('papyrus.html');
            }
        }

        // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≤—ã—Ö–æ–¥–∞
        window.addEventListener('beforeunload', function(e) {
            if (window.preventUnload) {
                e.preventDefault();
                e.returnValue = '';
                return '';
            }
        });

        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–∞—Ä—à—Ä—É—Ç
                const lastRoute = await getLastRoute();
                if (lastRoute && lastRoute !== window.location.href) {
                    console.log(`–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞: ${lastRoute}`);
                    safePageTransition(lastRoute, { saveHistory: false });
                    return;
                }

                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
                const savedGameId = localStorage.getItem('papaTrubok_lastGameId');
                if (savedGameId) {
                    const gameData = await getGameStateFromIndexedDB(savedGameId);
                    if (gameData) {
                        window.currentGame = gameData;
                        console.log('–°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è:', error);
            }
        });
    </script>
    <script src="game.js"></script>
    <script src="userAnswer.js"></script>
    <script src="auth.js"></script>
</body>
</html> 